---
title: "Association Rules"
author: "lxh"
date: "Monday, February 09, 2015"
output: html_document
---



```{r}
library("arules")
data("Adult")
class(Adult) #对象的类是 "transactions"
print(Adult) #显示交易数据个数（不能直接打印）
inspect(Adult) #显示交易数据的明细

```




```{r} 
rules <- apriori(Adult)
class(rules) #对象的类是 "rules"
print(rules) #显示规则个数（不能直接打印）
inspect(rules) #显示规则明细，有五个字段信息
# lhs: left-hand-side 先导
# rhs: right-hand-side 后导
# support: 支持度
# confidence: 置信度
# lift: 提升度

# subset 可以筛选规则
# Important operators to select itemsets containing items specified by their labels are
#  %in% (select itemsets matching any given item), ##匹配任意一个给定的元素 
# %ain% (select only itemsets matching all given item) and ##模糊匹配，类似 like '%xxx%'
# %pin% (%in% with partial matching). ##全匹配所有给定的元素


## select all rules with item "marital-status=Never-married" in 
## the right-hand-side and lift > 2
rules.sub <- subset(rules, subset = rhs %in% "marital-status=Never-married" 
                    & lift > 2)
inspect(rules.sub)
## 匹配任意给定的元素

## use partial matching for all items corresponding to the variable
## "marital-status"
## 模糊匹配
rules.sub <- subset(rules, subset = rhs %pin% "marital-status=")
inspect(rules.sub)

## select only rules with items "age=Young" and "workclass=Private" in
## the left-hand-side
## 匹配所有给到的元素
rules.sub <- subset(rules, subset = lhs %ain% 
                      c("age=Young", "workclass=Private"))
inspect(rules.sub)



关联规则的可视化
library("arulesViz")
plot(rules)
plot(rules, method="grouped")
plot(rules, method="graph")
plot(rules, method="graph", control=list(type="items")
plot(rules, method="paracoord", control=list(reorder=T))

```



最经典的、也是被举烂的栗子，就是沃尔玛的“啤酒和尿布”的故事。支持度就是所有非单商品交易中，啤酒（b）和尿布（d）同时出现的概率；置信度就是所有出现b的交易中又出现了d的概率（有些很严格的领域，通常会限制“如果d和b同时出现，那么能只包含这两个”，这是强关联）。
置信度是单向的，简单的说，“大部分购买尿布的人，同时会购买啤酒”的结论和“大部分购买啤酒的人同时会买几块尿布”的结论是不同的，而且根据结论来分析合理性，也会觉得前一个结论更加合理。

下面根据个人的经验以及理解，说说支持度和置信度的分析和选择（仅供参考，不负责^_^）。

一、支持度
支持度就是所有我们分析的交易中，某两种（若干种）商品同时（这里的同时，一般意味着同单或者一次独立的交易）被购买的概率（比率）。我们选择支持度的最终目的就是找出同时被购买的两个商品，可以提高我们的推荐转换率，从而增加收入。那么可以选出支持度最高的前n对（以下分析仅考虑两种商品，简称“对”）商品，我通常是选择总对数的万分之一或者是前20个。这样的数量不会很多，可以比较快的进行下一步分析，而且做推荐，要记住一点，“不能急功近利”。

根据万分之一或者前20，可以得到一个支持度，其实这个时候的支持度阀值，对本次分析已经意义不大了，主要是用于后续推荐系统的智能学习提供一个参考值。

二、置信度
置信度就是根据某一个条件，得到一个结论的可信程度、可靠程度。例子中，“购买了尿布”这个条件，可以推出“同时也会购买啤酒”这个结论的可靠程度很高，百度百科关联规则_百度百科 中分析的数据表明沃尔玛尿布到啤酒的置信度高达70%。

```{r}
dvdtrans <- read.csv(system.file("csv", "dvdtrans.csv", package="rattle"))  
print(dvdtrans)
str(dvdtrans)
levels(dvdtrans$Item) #交易中都有哪些电影,备注对应的中文名
# "Braveheart"（勇敢的心）  
# "Gladiator"（角斗士）
# "Green Mile" （绿里奇迹）
# "Harry Potter1"（哈利波特1）
# "Harry Potter2"（哈利波特1）
# "LOTR"（魔戒）         
# "LOTR1"（魔戒1）
# "LOTR2"（魔戒2）
# "Patriot"（爱国者）
# "Sixth Sense"（灵异第六感—）
table(dvdtrans) # 列联表


library("arules")
        
# 将数据转换为arules关联规则方法apriori 可以处理的数据形式.交易数据
dvd_transdata <- as(split(dvdtrans$Item, dvdtrans$ID), "transactions")

# 数据概括：各项属性
attributes(dvd_transdata)

# 检查交易数据
inspect(dvd_transdata)

# 使用apriori函数生成关联规则
rules <- apriori(dvd_transdata, parameter = list(supp = 0.6, conf = 0.8, minlen = 2, target = "rules"))

inspect(rules)


library("arulesViz")
plot(rules)

```
